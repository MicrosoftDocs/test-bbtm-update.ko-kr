### YamlMime:Yaml
ms.openlocfilehash: 0bdd94bf968768987280e6ccb8ed3c538961e5bc
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/11/2022
ms.locfileid: "139906065"
Slug: building-a-highly-available-on-premises-vpn-gateway
Title: '고가용성 온-프레미스 VPN 게이트웨이 빌드 '
Summary: 이 블로그는 Azure에 연결하는 Windows 기술을 사용하여 고가용성 온-프레미스 VPN 게이트웨이를 설정하는 단계별 가이드를 제공합니다.
Content: >-
  <h4></h4>

  <h1>개요</h1>

  하이브리드 네트워킹을 사용하면 기업에서 온-프레미스 네트워크를 Azure와 같은 클라우드 서비스 공급자에 연결할 수 있습니다. 기업이 점점 더 워크로드를 클라우드로 마이그레이션함에 따라 클라우드 간 연결을 고가용성으로 마이그레이션해야 합니다. 이 블로그에서는 Windows Server 기술을 사용하는 기업이 2노드 장애 조치(failover) 클러스터에서 온-프레미스 사이트 간 VPN Gateway를 빌드하고 Azure에 연결하는 방법을 설명합니다. <a href="https://technet.microsoft.com/en-us/library/hh831579.aspx">장애 조치(failover) 클러스터링을</a> 사용하면 소프트웨어 버그 또는 하드웨어 문제로 인해 한 클러스터 노드가 노드에서 실행되는 서비스(이 경우 사이트 간 VPN)가 다른 노드로 빠르게 이동되어 서비스 가동 중지 시간을 최소화할 수 있습니다.

  <h1>토폴로지 설정</h1>

  다음 다이어그램에서는 설정할 2노드 클러스터의 논리적 토폴로지를 보여 줍니다.


  <a href="https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/07/Topology.png"><img style="padding-top: 0px; padding-left: 0px; padding-right: 0px; border-width: 0px;" title="토폴로지" alt="Topology" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Topology_thumb.png" width="769" height="346" border="0" /></a>


  두 노드는 세 개의 네트워크에 연결됩니다. 외부 네트워크가 공용 인터넷에 연결되어 있습니다. 내부 네트워크는 엔터프라이즈의 온-프레미스 네트워크입니다. 관리 및 클러스터 서비스는 세 번째 네트워크에서 실행됩니다.

  <h1>필수 조건</h1>

  사이트 간 VPN 게이트웨이는 각각 Hyper-V 서버에서 호스트되는 두 개의 가상 머신에서 실행되도록 구성됩니다. <b>가상 머신과 Hyper-V 서버는 모두 R2를 Windows Server 2012 실행해야 합니다</b>.


  Hyper-V 서버는 세 네트워크 모두에 연결됩니다. <b>Hyper-V 스위치가 미리 구성되어 있습니다. 가상 머신에 대한 VHD를 사용할 준비가 된 것입니다</b>.


  장애 조치(failover) 클러스터링을 사용하려면 여기서 두 가상 머신인 모든 클러스터 노드를 도메인에 가입해야 합니다. 따라서 <b>Active Directory 서버를 미리 구성하고 관리/클러스터 네트워크에서 실행해야 합니다</b>.


  2노드 클러스터는 세 번째 "미러링 모니터 서버"와 함께 더 잘 제공됩니다. 두 노드가 서로 통신하지 못하는 경우 미러링 모니터 서버는 활성 노드를 지명하는 데 도움이 될 수 있습니다. 이 연습에서는 파일 공유를 미러링 모니터 서버로 사용합니다. 파일 공유는<b> 관리/클러스터 네트워크에서 실행되는 미리 구성된 파일 서버에</b> 있습니다.


  <b>DHCP는 세 네트워크 중 어느 네트워크에서도 실행되도록 구성되지 않았습니다. </b> 두 가상 머신에 대한 관리 IP는 관리 네트워크 인터페이스에서 정적으로 구성됩니다. 내부/외부 네트워크 인터페이스는 처음에 <a href="https://en.wikipedia.org/wiki/Apipa">APIPA</a> 를 가져옵니다. "실제" 내부 IP 주소 및 외부 IP 주소는 아래 설명된 대로 클러스터 리소스로 배관됩니다.

  <h1>구성</h1>

  다음 두 섹션으로 단계를 세분화합니다.

  <ul>
   <li>Hyper-V 호스트 구성</li>
   <li>가상 머신 구성</li>
  </ul>

  <h2>Hyper-V 호스트 구성</h2>

  첫 번째 가상 머신을 호스트하는 첫 번째 Hyper-V 호스트에 다음 PowerShell 구성을 적용해야 합니다. 두 번째 가상 머신의 이름을 제외한 동일한 구성을 두 번째 Hyper-V 호스트에 적용해야 합니다.

  <table border="1" cellspacing="0" cellpadding="0">

  <tbody>

  <tr>

  <td valign="top" width="623">

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#외부 및 내부 스위치가 미리 구성됨</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"인터넷"</span></span> $externalSwitch</span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"OnPrem"</span></span> $internalSwitch</span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#두 번째 가상 머신의 이름을 바꿔야 합니다.</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"VPN_GW_1" $vm</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#VHD 경로 채우기</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">new-vm</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-SwitchName</span></span> <span><span style="color: #ff4500;">$externalSwitch</span></span> <span><span style="color: #000080;">-VHDPath</span></span> <span><span style="color: #8a2be2; background-color: #ffff00;">&lt;VHD 경로&gt;</span></span> <span><span style="color: #000080;">-MemoryStartupBytes</span></span> <span><span style="color: #800080;">2GB</span></span> <span><span style="color: #000080;">-2세대</span></span> </span><span><span style="color: #800080; font-size: 9pt;"></span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#이 VM NIC는 외부 스위치에 연결됩니다. 그래서 그것은 공공 인터넷에 직면하고있다</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Rename-VMNetworkAdapter</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-VMName</span></span> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-NewName</span></span> </span><span><span style="color: #8a2be2; font-size: 9pt;">InternetNIC</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#VM NIC를 추가하여 내부 네트워크에 연결</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Add-VMNetworkAdapter</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-VMName</span></span> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-VMNetworkAdapterName</span></span> <span><span style="color: #8a2be2;">InternalNIC</span></span> <span><span style="color: #000080;">-SwitchName</span></span> </span><span><span style="color: #ff4500; font-size: 9pt;">$internalSwitch</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#VM NIC를 추가하여 관리/클러스터 네트워크에 연결</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Add-VMNetworkAdapter</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-VMName</span></span> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-VMNetworkAdapterName</span></span> <span><span style="color: #8a2be2;">ManagementNIC</span></span> <span><span style="color: #000080;">-SwitchName</span></span> </span><span><span style="color: #ff4500; font-size: 9pt;">$internalSwitch</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#이 연습에서는 VLAN 2에서 관리/클러스터 네트워크를 만듭니다.</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> </span>$managementVLAN <span><span style="color: #800080; font-size: 9pt;">2</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Set-VMNetworkAdapterVlan</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-VMName</span></span> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-VMNetworkAdapterName</span></span> <span><span style="color: #8a2be2;">ManagementNIC</span></span> <span><span style="color: #000080;">-Access</span></span> <span><span style="color: #000080;">-VlanId</span></span> </span><span><span style="color: #ff4500; font-size: 9pt;">$managementVLAN</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#이 연습에서는 VLAN 11에서 내부 네트워크를 만듭니다.</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> </span>$internalVLAN <span><span style="color: #800080; font-size: 9pt;">11</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#내부 NIC에서 다중 테넌시를 사용하도록 설정합니다. 블로그에서 설명 보기</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Set-VmNetworkAdapterIsolation</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-VMName</span></span> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-VMNetworkAdapterName</span></span> <span><span style="color: #8a2be2;">InternalNIC</span></span> <span><span style="color: #000080;">-MultiTenantStack</span></span> <span><span style="color: #8a2be2;">on</span></span> <span><span style="color: #000080;">-IsolationMode</span></span> <span><span style="color: #8a2be2;">Vlan</span></span> <span><span style="color: #000080;">-AllowUntaggedTraffic</span></span> </span><span><span style="color: #ff4500; font-size: 9pt;">$true</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Add-VmNetworkAdapterRoutingDomainMapping</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-VMName</span></span> <span><span style="color: #ff4500;">$vm</span></span> <span><span style="color: #000080;">-VMNetworkAdapterName</span></span> <span><span style="color: #8a2be2;">InternalNIC</span></span> <span><span style="color: #000080;">-RoutingDomainID</span></span> <span><span style="color: #8b0000;">"{10000000-1000-1000-1000-000000000001}"</span></span> <span><span style="color: #000080;">-RoutingDomainName</span></span> <span><span style="color: #8b0000;">"Onprem"</span></span> <span><span style="color: #000080;">-IsolationID</span></span> <span><span style="color: #ff4500;">$internalVLAN</span></span> <span><span style="color: #000080;">-IsolationName</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"OnPremVLAN"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Start-vm</span></span></span><span><span><span style="color: #ff4500; font-size: 9pt;">$vm </span></span></span></span></p>

  </td>

  </tr>

  </tbody>

  </table>

  외부 NIC "InternetNIC"에 대해 VLAN이 구성되지 않았습니다. 트래픽은 Hyper-V 호스트가 연결된 외부 NIC와 실제 네트워크 간에 태그가 지정되지 않습니다.


  <a href="https://technet.microsoft.com/en-us/library/dn464283.aspx">Set-VmNetworkAdapterIsolation</a> 및 <a href="https://technet.microsoft.com/en-us/library/dn464285.aspx">Add-VmNetworkAdapterRoutingDomainMapping</a> 이 주요 구성입니다. <b>사이트간 VPN에 대한 장애 조치(failover) 클러스터링은 게이트웨이가 다중 테넌트 모드에 있는 경우에만 지원됩니다.</b> 이 두 cmdlet은 가상 머신을 다중 테넌트로 설정합니다. 특히 내부 네트워크에 대해 별도의 라우팅 도메인인 "Onprem"을 추가했습니다. VLAN 11은 이 라우팅 도메인의 트래픽 식별자입니다. 라우팅 도메인 ID 및 이름을 적어둡니다. 나중에 어떻게 사용되는지 설명하겠습니다.


  호스트 구성이 완료되었습니다. <b>두 Hyper-V 호스트에 대한 장애 조치(failover) 클러스터를 만들 필요가 없습니다</b>.

  <h2>가상 머신 구성</h2>

  두 가상 머신 모두 현재 실행 중이어야 합니다. 더 진행하려면 <b>두 컴퓨터에서 다음</b> 구성을 수행해야 합니다.

  <ul>
   <li>Active Directory에서 호스트되는 도메인 가입</li>
   <li>도메인 사용자를 관리자로 추가</li>
   <li>외부 네트워크에 연결된 네트워크 어댑터의 이름을 "인터넷"으로 바꿉니다. <i>내부 네트워크 어댑터와 관리 네트워크 어댑터의 이름을 바꾸는 것은 선택 사항입니다.</i></li>
   <li>장애 조치 클러스터링 설치 빠른 방법은 다음 두 PowerShell cmdlet을 실행하는 것입니다.</li>
  </ul>

  <table border="1" cellspacing="0" cellpadding="0">

  <tbody>

  <tr>

  <td valign="top" width="623">

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Get-WindowsFeature</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #8a2be2;">*클러스터*</span></span> <span><span style="color: #a9a9a9;">|</span></span></span><span><span style="color: #0000ff; font-size: 9pt;">Install-WindowsFeature</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Get-WindowsFeature</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #8a2be2;">*파일*</span></span> <span><span style="color: #a9a9a9;">|</span></span></span><span><span style="color: #0000ff; font-size: 9pt;">Install-WindowsFeature</span></span></span></span></p>

  </td>

  </tr>

  </tbody>

  </table>

  장애 조치(failover) 클러스터링이 설치되면 <b>두 가상 머신 중 하나에서 다음 구성을 실행하지만 둘 다 실행하지는 않습니다</b>.

  <table border="1" cellspacing="0" cellpadding="0">

  <tbody>

  <tr>

  <td valign="top" width="623">

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#두 가상 머신의 이름이 각각 "VPN_GW_1" 및 "VPN_GW_2"로 바뀌었습니다.</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">$clustername "OnPremGW"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span> $clusternodes @(<span><span style="color: #8b0000;">"VPN_GW_1"</span></span><span><span style="color: #a9a9a9;">,</span></span><span><span style="color: #8b0000;">"VPN_GW_2"</span></span>)</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">new-cluster</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #ff4500;">$clustername</span></span> <span><span style="color: #000080;">-Node</span></span> <span><span style="color: #ff4500;">$clusternodes</span></span> </span><span><span style="color: #000080; font-size: 9pt;">-NoStorage</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#"클러스터"는 파일 서버에 미리 구성된 파일 폴더입니다.</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Set-ClusterQuorum</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">–FileShareWitness</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"\\FS\Cluster"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;"># 내부 네트워크에 대한 내부 IP 주소 추가</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span>$res <span><span style="color: #0000ff;">Add-ClusterResource</span></span> <span><span style="color: #000080;">-ResourceType</span></span> <span><span style="color: #8b0000;">"Disjoint IPv4 Address"</span></span> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8b0000;">"InternalAddress"</span></span> <span><span style="color: #000080;">-Group</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"Cluster Group"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">|</span></span>$res <span><span style="color: #0000ff;">Set-ClusterParameter</span></span> <span><span style="color: #000080;">-Multiple</span></span> @{<span><span style="color: #8b0000;">"PrefixLength""</span></span><span><span style="color: #a9a9a9;">=</span></span><span><span style="color: #8b0000;">24"</span></span>;<span><span style="color: #8b0000;">" Address""</span></span><span><span style="color: #a9a9a9;">=</span></span><span><span style="color: #8b0000;">192.168.200.1"</span></span>;<span><span style="color: #8b0000;">" VSID"</span></span><span><span style="color: #a9a9a9;">=</span></span><span><span style="color: #8b0000;">"11"</span></span>;<span><span style="color: #8b0000;">" RDID""</span></span><span><span style="color: #a9a9a9;">=</span></span><span><span style="color: #8b0000;">"{10000000-1000-1000-1000-000000000001}</span></span>}</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Start-ClusterResource</span></span></span><span><span><span style="color: #ff4500; font-size: 9pt;">$res</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;"># 인터넷을 향한 외부 IP 추가</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span>$res <span><span style="color: #0000ff;">Add-ClusterResource</span></span> <span><span style="color: #000080;">-ResourceType</span></span> <span><span style="color: #8b0000;">"Disjoint IPv4 Address"</span></span> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8b0000;">"ExternalAddress"</span></span> <span><span style="color: #000080;">-Group</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"Cluster Group"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">|</span></span>$res <span><span style="color: #0000ff;">Set-ClusterParameter</span></span> <span><span style="color: #000080;">-Multiple</span></span> @{<span><span style="color: #8b0000;">"PrefixLength""</span></span><span><span style="color: #a9a9a9;">=</span></span><span><span style="color: #8b0000;">24"</span></span>;<span><span style="color: #8b0000;">" 주소"</span></span><span><span style="color: #a9a9a9;">=</span></span><span><span style="color: #8b0000;">"131.</span></span> <span><span style="background-color: #000000;">xx.xx.xx</span></span><span><span style="color: #8b0000;">"</span></span>; <span><span style="color: #8b0000;">"AdapterName"</span></span><span><span style="color: #a9a9a9;">=</span></span> <span><span style="color: #8b0000;">"인터넷"</span></span>}</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Start-ClusterResource</span></span></span><span><span><span style="color: #ff4500; font-size: 9pt;">$res</span></span></span></span></p>

  </td>

  </tr>

  </tbody>

  </table>

  앞에서 설명한 대로 <a href="https://blogs.technet.com/b/askpfeplat/archive/2012/06/27/clustering-what-exactly-is-a-file-share-witness-and-when-should-i-use-one.aspx">파일 공유 감시</a> 는 이 클러스터에 대해 구성됩니다. 특히 \\FS\Cluster는 파일 서버의 파일 폴더일 뿐입니다. 두 가상 머신 모두 파일 폴더에 대한 읽기/쓰기 액세스 권한이 있는지 확인합니다.


  <b>"연결되지 않는 IPv4 주소"는 Windows Server 2012 R2에 추가된 새 클러스터 리소스 유형입니다</b>. Windows Server의 GUI 도구인 장애 조치(failover) 클러스터 관리자가 아닌 PowerShell에서만 구성할 수 있습니다. 이 리소스 유형의 IP 주소 2개(내부 네트워크용 및 외부 네트워크용 주소)를 추가했습니다.

  <ul>
   <li>내부 주소는 라우팅 도메인 ID 및 VLAN 번호로 식별되는 클러스터 네트워크에 대해 배관됩니다. 앞에서 Hyper-V 호스트의 내부 네트워크 어댑터에 매핑했습니다. 이 주소는 Azure에 연결해야 하는 내부 네트워크의 모든 머신에 대한 기본 게이트웨이 주소입니다.</li>
   <li>외부 주소는 네트워크 어댑터 이름으로 식별되는 클러스터 네트워크에 대해 배관됩니다. 두 가상 머신에서 외부 네트워크 어댑터의 이름을 "인터넷"으로 변경했습니다.</li>
  </ul>

  &nbsp;


  다른 클러스터 리소스와 마찬가지로 두 주소는 모두 클러스터의 활성 노드에서 소유합니다. 활성 노드가 실패할 때마다 두 주소는 새 활성 노드로 연결됩니다.


  다음 단계는 <b>두 가상 머신에</b> 기본 경로를 설치하는 것입니다.

  <table border="1" cellspacing="0" cellpadding="0">

  <tbody>

  <tr>

  <td valign="top" width="623">

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">New-NetRoute</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-InterfaceAlias</span></span> <span><span style="color: #8a2be2;">Internet</span></span> <span><span style="color: #000080;">-DestinationPrefix</span></span> <span><span style="color: #8a2be2;">0.0.0.0/0</span></span> <span><span style="color: #000080;">-NextHop</span></span> <span><span style="color: #8a2be2;">131.</span></span><span><span style="background-color: #000000;">xx.xx.xx</span></span></span></span></span></p>

  </td>

  </tr>

  </tbody>

  </table>

  <b>각 가상 머신에 하나의 기본 경로만 있는 것이 중요합니다. DHCP가 네트워크에서 실행되는 경우 일반적으로 DHCP 서버를 가리키도록 기본 경로가 설치됩니다. 해당 경로를 삭제해야 합니다.</b>


  다음 단계는 <b>두 가상 머신에</b> 사이트 간 VPN 기능을 설치하는 것입니다.

  <table border="1" cellspacing="0" cellpadding="0">

  <tbody>

  <tr>

  <td valign="top" width="623">

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Add-WindowsFeature</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8a2be2;">RemoteAccess</span></span> <span><span style="color: #000080;">-IncludeAllSubFeature</span></span> </span><span><span style="color: #000080; font-size: 9pt;">-IncludeManagementTools</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Install-RemoteAccess-Multitenancy</span></span></span><span><span><span style="color: #000080; font-size: 9pt;"></span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Enable-RemoteAccessRoutingDomain</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8a2be2;">Onprem</span></span> <span><span style="color: #000080;">-Type</span></span> </span><span><span style="color: #8a2be2; font-size: 9pt;">VpnS2S </span></span></span></span></p>

  </td>

  </tr>

  </tbody>

  </table>

  "Onprem"은 Hyper-V 호스트를 구성할 때 이전에 추가한 라우팅 도메인의 이름입니다. Hyper-V 호스트는 구성을 가상 머신에 공급하여 각 라우팅 도메인에 대한 <i>구획</i> 을 만듭니다. Get-NetCompartment 두 가상 머신에서 실행할 때 다음 출력을 표시해야 합니다.


  <a href="https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/07/get-netcompartment.png"><img style="padding-top: 0px; padding-left: 0px; padding-right: 0px; border-width: 0px;" title="get-netcompartment" alt="get-netcompartment" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/get-netcompartment_thumb.png" width="470" height="140" border="0" /></a>


  라우팅 도메인 ID와 이름은 기본적으로 구획 GUID 및 설명입니다.


  마지막으로 구성을 완료하려면 <b>클러스터의 활성 노드인 가상 머신에서</b> 다음 PowerShell cmdlet을 실행합니다.

  <table border="1" cellspacing="0" cellpadding="0">

  <tbody>

  <tr>

  <td valign="top" width="623">

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#Azure에 연결할 인터페이스를 추가합니다. 공유 키 입력</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Add-VpnS2SInterface</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-Protocol</span></span> <span><span style="color: #8a2be2;">IKEv2</span></span> <span><span style="color: #000080;">-AuthenticationMethod</span></span> <span><span style="color: #8a2be2;">PSKOnly</span></span> <span><span style="color: #000080;">-NumberOfTries</span></span> <span><span style="color: #800080;">3</span></span> <span><span style="color: #000080;">-ResponderAuthenticationMethod</span></span> <span><span style="color: #8a2be2;">PSKOnly</span></span> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8a2be2;">168.</span></span><span><span style="background-color: #000000;">xx.xx.xx</span></span> <span><span style="color: #000080;">-Destination</span></span> <span><span style="color: #8a2be2;">168.</span></span><span><span style="background-color: #000000;">xx.xx.xx</span></span> <span><span style="color: #000080;">-IPv4Subnet</span></span> @(<span><span style="color: #8b0000;">"10.0.0.0/8:100"</span></span>) <span><span style="color: #000080;">-SharedSecret</span></span> <span><span style="color: #8a2be2; background-color: #ffff00;">&lt;공유 키&gt;</span></span> <span><span style="color: #000080;">-RoutingDomain</span></span> </span><span><span style="color: #8a2be2; font-size: 9pt;"> Onprem</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="font-size: 9pt;"> </span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span><span style="font-family: Lucida Console;"><span style="color: #006400; font-size: 9pt;">#클러스터 리소스를 추가하여 VPN 구성을 동기화 상태로 유지</span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Add-ClusterResourceType</span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8b0000;">"RAS Cluster Resource"</span></span> <span><span style="color: #000080;">-Dll</span></span> </span><span><span style="color: #8a2be2; font-size: 9pt;">RasClusterRes.dll</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">=</span></span>$res <span><span style="color: #0000ff;">Add-ClusterResource</span></span> <span><span style="color: #000080;">-ResourceType</span></span> <span><span style="color: #8b0000;">"RAS 클러스터 리소스"</span></span> <span><span style="color: #000080;">-이름</span></span> <span><span style="color: #8b0000;">"S2SVPN"</span></span> <span><span style="color: #000080;">-그룹</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"클러스터 그룹"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #ff4500;"><span style="font-size: 9pt;"></span></span></span><span><span style="font-size: 9pt;"> <span><span style="color: #a9a9a9;">|</span></span>$res <span><span style="color: #0000ff;">Set-ClusterParameter</span></span> <span><span style="color: #000080;">-Name</span></span> <span><span style="color: #8b0000;">"ConfigExportPath"</span></span> <span><span style="color: #000080;">-Value</span></span> </span><span><span style="color: #8b0000; font-size: 9pt;">"\\FS\Cluster"</span></span></span></span></p>

  <p class="MsoNormal" style="background: white; margin: 0in 0in 8pt; line-height: 12pt;"><span style="font-family: Lucida Console;"><span><span style="color: #0000ff;"><span style="font-size: 9pt;">Start-ClusterResource</span></span></span><span><span><span style="color: #ff4500; font-size: 9pt;">$res </span></span></span></span></p>

  </td>

  </tr>

  </tbody>

  </table>

  사이트간 VPN 게이트웨이는 다중 테넌트이므로 VPN 연결이 종료되는 위치에 라우팅 도메인을 지정해야 합니다. 이 연습에서는 분명히 "Onprem"입니다.


  <b>"RAS 클러스터 리소스"는 Windows Server 2012 R2에 추가된 또 다른 새 클러스터 리소스 유형입니다</b>. 이 리소스 개체는 사이트-사이트 VPN 구성이 저장되는 위치를 지정합니다. 파일 공유는 두 가상 머신이 읽기/쓰기 액세스 권한이 있는 모든 위치에 있을 수 있습니다. 간단하게 유지하기 위해 이전에 클러스터에 대한 파일 공유 감시로 구성된 것과 동일한 파일 폴더를 선택했습니다. 활성 노드가 실패하면 대기 노드는 이 폴더에서 구성을 읽고 Azure에 다시 연결합니다.

  <h2>확인</h2>

  Azure의 가상 네트워크 게이트웨이가 이미 구성되어 있다고 가정합니다. 사이트 및 사이트 간의 VPN 연결이 실행 중이어야 합니다. Get-VpnS2SInterface 다음 출력을 제공해야 합니다.


  <a href="https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/07/clip_image002.jpg"><img style="padding-top: 0px; padding-left: 0px; padding-right: 0px; border-width: 0px;" title="clip_image002" alt="clip_image002" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/clip_image002_thumb.jpg" width="628" height="61" border="0" /></a>


  활성 클러스터 노드가 실패한 후 온-프레미스 네트워크와 Azure 간의 연결이 다시 시작되는지 확인하려면 사이트 간 VPN이 항상 활성 노드에서 실행된다는 점을 기억합니다. Windows Server의 GUI 도구인 Hyper-V Manager에서 가상 머신을 끄기만 하면 됩니다. 내부 네트워크의 로컬 컴퓨터에서 내부 주소 192.168.200.1과 Azure의 VM(10.0.20.4)을 모두 ping합니다. 아래에서 볼 수 있듯이 4개의 ping 패킷이 손실된 후 새 활성 노드에 대한 연결이 다시 시작됩니다. 그리고 얼마 지나지 않아 한 번의 추가 패킷 손실로 Azure에 대한 연결도 다시 시작됩니다.


  <i>로컬 컴퓨터에서 온-프레미스 사이트-사이트 VPN 게이트웨이로 Ping:</i>


  <a href="https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/07/clip_image003.png"><img style="padding-top: 0px; padding-left: 0px; padding-right: 0px; border-width: 0px;" title="clip_image003" alt="clip_image003" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/clip_image003_thumb.png" width="517" height="227" border="0" /></a>


  <i>사이트-사이트 VPN 연결을 통해 로컬 컴퓨터에서 Azure VM으로 Ping:</i>


  <a href="https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/07/clip_image004.png"><img style="padding-top: 0px; padding-left: 0px; padding-right: 0px; border-width: 0px;" title="clip_image004" alt="clip_image004" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/clip_image004_thumb.png" width="506" height="186" border="0" /></a>
