### YamlMime:Yaml
ms.openlocfilehash: f7d498bc3c63c591d4169bb594ed195e3a27c21c
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/11/2022
ms.locfileid: "139908719"
Slug: the-right-way-to-handle-azure-onstop-events
Title: Azure OnStop 이벤트를 처리하는 올바른 방법
Summary: '편집자 주: 이 게시물은 Rick Andersonwho&nbsp;가 Windows Azure 및 ASP.NET MVC 팀의 프로그래머/작가입니다.  웹 역할에 대한 다시 시작은 Windows 고려 사항을 무시한 경우가 많습니다...'
Content: '<p><strong>편집기 참고 사항: </strong> 이 게시물은 <strong><a href="https://twitter.com/RickAndMSFT" target="_blank">Rick Andersonwho</a>&nbsp;</strong>가 Windows Azure 및 ASP.NET MVC 팀의 프로그래머 / 작가입니다.</p>  <h4>웹 역할에 대한 다시 시작</h4>  <p>Windows Azure에서 종종 무시되는 고려 사항은 다시 시작을 처리하는 방법입니다. &rsquo;다시 시작을 올바르게 처리하는 것이 중요하므로 데이터가 손실되거나 지속된 데이터가 손상되지 않으므로&rsquo; 새 요청을 신속하게 종료, 다시 시작 및 효율적으로 처리할 수 있습니다.&nbsp; Windows Azure Cloud Service 애플리케이션은 운영 체제 업데이트를 위해 매월 약 두 번 다시 시작됩니다. (OS 업데이트에 대한 자세한 내용은 <a href="https://blogs.msdn.com/b/kwill/archive/2012/09/19/role-instance-restarts-due-to-os-upgrades.aspx" target="_blank">OS 업그레이드로 인한 역할 인스턴스 다시 시작을 참조하세요</a>.) 웹 애플리케이션이 종료될 때 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">RoleEnvironment.Stopping</a> 이벤트가 발생합니다. Visual Studio 만든 웹 역할 상용구는 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx">OnStop</a> 메서드를 재정의하지 않으므로 애플리케이션이 종료되기 전에 HTTP 요청 처리를 완료하는 데 몇 초밖에 걸리지 않습니다. 웹 역할이 보류 중인 요청으로 사용 중인 경우 이러한 요청 중 일부가 손실될 수 있습니다. <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStopmethod</a>&nbsp;를 재정의하고 Sleep을 호출하여 다시 시작 또는 웹 역할을 최대 5분까지 지연할 수 있지만 최적과는&rsquo; 거리가 멀다. <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">중지</a> 이벤트가 발생하면 LB(Load Balance)가 웹 역할에 대한 요청 전송을 중지하므로 보류 중인 요청을 처리하는 데 걸리는 시간보다 더 오래 다시 시작을 지연하면 가상 머신이 절전 모드에서 회전하므로 유용한 작업이 없습니다. 최적의 방법은 더 이상 요청이 없을 때까지 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 메서드에서 기다린 다음 종료를 시작하는 것입니다. 빨리 종료할수록 VM을 더 빨리 다시 시작하고 요청 처리를 시작할 수 있습니다. 최적의 종료 전략을 구현하려면 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx" target="_blank">WebRole</a> 클래스에 다음 코드를 추가합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4251.aa.PNG" alt="" border="0"></a></p>  <p>위의 코드는 ASP.NET 요청&rsquo; 현재 카운터를 확인합니다. 요청이 있는 한 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 메서드는 절전 모드를 호출하여 종료를 지연합니다. 현재 요청&rsquo; 카운터가 0으로 떨어지면 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 이 반환되어 종료가 시작됩니다. 웹 서버가 너무 바빠서 보류 중인 요청을 5분 안에 완료할 수 없는 경우 애플리케이션은 어쨌든 종료됩니다. <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">중지</a> 이벤트가 발생하면 LB가 웹 역할에 대한 요청 전송을 중지하므로 크기가 큰 웹 역할(또는 인스턴스 수가 너무 적음)이 없는 경우 현재 요청을 완료하는 데 몇 초 이상이 필요하지 않습니다.</p>  <p>위의 코드는 추적 데이터를 작성하지만 까다로운 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/gg433075.aspx" target="_blank">주문형 전송</a>을 수행하지 않는 한 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 메서드의 추적 데이터는 <strong>WADLogsTable</strong>에 표시되지 않습니다. 이 블로그의&rsquo; 뒷부분에서 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">DebugView</a> 를 사용하여 이러한 추적 이벤트를 보는 방법을 보여 줍니다. 또한 Ill&rsquo;은 웹 역할 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx" target="_blank">OnStart</a> 메서드에서 추적 작업을 수행하는 방법도 보여 줄 수 있습니다.</p>  <h4>작업자 역할에 대한 최적의 다시 시작</h4>  <p>작업자 역할에서 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">중지</a> 이벤트를 처리하려면 다른 접근 방식이 필요합니다. 일반적으로 작업자 역할은 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx" target="_blank">Run</a> 메서드에서 큐 메시지를 처리합니다. 이 전략에는 두 가지 글로벌 변수가 포함됩니다. 하나는 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">중지</a> 이벤트가 발생했음을 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx" target="_blank">Run</a> 메서드에 알리고 다른 전역은 종료를 시작하는 것이&rsquo; 안전하다는 것을 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 메서드에 알립니다. ( <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a>에서 반환하여 종료가 시작됩니다.) 다음 코드에서는 두 가지 전역 방법을 보여 줍니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5102.aa1.PNG" alt="" border="0"></a></p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7484.aa2.PNG" alt="" border="0"></a></p>  <p><a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a>이 호출되면 전역 <strong>onStopCalled</strong>가 true로 설정되며, 큐 이벤트가 처리되지 않을 때 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx" target="_blank">Run</a> 메서드의 코드가 루프 맨 위에서 종료되도록 신호를 표시합니다.</p>  <h4>온스톱 추적 데이터 보기</h4>  <p>앞에서 설명한 것처럼 까다로운 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/gg433075.aspx" target="_blank">주문형 전송</a>을 수행하지 않는 한 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 메서드의 추적 데이터는 <strong>WADLogsTable</strong>에 표시되지 않습니다. Well&rsquo;은 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">Dbgview</a> 를 사용하여 이러한 추적 이벤트를 확인합니다. 솔루션 탐색기에서 클라우드 프로젝트를 마우스 오른쪽 단추로 클릭하고 <strong>게시</strong>를 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1565.aa3.png" alt="" border="0"></a></p>  <p>게시 프로필을 다운로드합니다.&nbsp; <strong>Azure 애플리케이션 게시 Windows</strong> 대화 상자에서 <strong>디버그</strong>를 선택하고 모든 역할에 <strong>대해 원격 데스크톱 사용을</strong> 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0116.aa4.png" alt="" border="0"></a></p>  <p>컴파일러는 릴리스 빌드에서 추적 호출을 제거하므로&rsquo; 빌드 구성을 <strong>Debugto</strong>&nbsp;로 설정하여 추적 데이터를 확인해야 합니다. 애플리케이션이 게시되고 실행되면 Visual Studio <strong>서버 탐색기</strong>(Ctl+Alt+S)를 선택합니다. <strong>Windows Azure Compute</strong>를 선택한 다음, 클라우드 배포를 선택합니다. (이 경우&rsquo; t6&rsquo;이라고 하고 프로덕션 배포를 호출합니다.) 웹 역할 인스턴스를 선택하고 마우스 오른쪽 단추를 클릭한 <strong>다음 원격 데스크톱을 사용하여 커넥트</strong> 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/3223.aa5.png" alt="" border="0"></a></p>  <p>RDC(원격 데스크톱 연결)는 게시 마법사에서 지정한 계정 이름을 사용하고 입력한 암호를 묻는 메시지를 표시합니다. 작업 표시줄의 왼쪽에서 <strong>서버 관리자</strong> 아이콘을 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8463.aa6.png" alt="" border="0"></a></p>  <p><strong>서버 관리자</strong>의 왼쪽 탭에서 <strong>로컬 서버를</strong> 선택한 다음 <strong>IE ESC(보안 강화 구성</strong>)를 선택합니다. IE ESC 대화 상자에서 라디오 끄기 단추를 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1447.aa7.png" alt="" border="0"></a></p>  <p>Internet Explorer를 시작하고 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">DebugView</a>를 다운로드하여 설치합니다. <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">DebugView</a>를 시작하고 <strong>캡처</strong> 메뉴에서 <strong>전역 Win32 캡처</strong>를 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8688.aa8.png" alt="" border="0"></a></p>  <p>필터 아이콘을 선택하고 다음 제외 필터를 입력합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4532.0.PNG" alt="" border="0"></a></p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0246.aa9.png" alt="" border="0"></a></p>  <p>이 테스트에서는 이름에서 설명한 대로 종료/다시 시작 시퀀스를 시작하는 <strong>About</strong> 작업 메서드에 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.requestrecycle.aspx" target="_blank">RoleEnvironment.RequestRecycle</a>&nbsp; 메서드를 추가했습니다. 또는 애플리케이션을 다시 게시할 수 있습니다. 그러면 종료/다시 시작 시퀀스도 시작됩니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8561.aa10.png" alt="" border="0"></a></p>  <p>동일한 절차에 따라 작업자 역할 VM에서 추적 데이터를 봅니다. 작업자 역할 인스턴스를 선택하고 마우스 오른쪽 단추를 클릭하고 <strong>원격 데스크톱을 사용하여 커넥트</strong> 선택합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8306.aa11.png" alt="" border="0"></a></p>  <p>위의 절차에 따라 <strong>IE 보안 강화 구성을</strong> 사용하지 않도록 설정합니다. 위의 지침을 사용하여 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">DebugView</a> 를 설치하고 구성합니다. 작업자 역할에 대해 다음 필터를 사용합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4606.00.PNG" alt="" border="0"></a></p>  <p>&nbsp;이 샘플에서는 종료/다시 시작 프로시저를 발생시키는 Azure 패키지를 게시했습니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7607.aa12.png" alt="" border="0"></a></p>  <p>마지막 출발 팁: <strong>웹 역할 OnStart</strong> 메서드에서 추적 작업을 수행하려면 다음을 추가합니다.</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4130.000.PNG" alt="" border="0"></a></p>  <p>&rsquo;<strong>WADLogsTable</strong>에 표시하기 위해 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> 메서드에서 추적&nbsp; 데이터를 가져오는 블로그에 나와 같은 경우 알려주세요.&nbsp; 이 블로그의 대부분의 정보는 <a href="https://azure.microsoft.com/en-us/develop/net/tutorials/multi-tier-web-site/1-overview/" target="_blank">Azure 다중 계층 자습서</a> Tom에서 가져온 것이며 지난 주에 게시했습니다. 다른 많은 좋은 팁에 대 한 그것을 체크 아웃 해야 합니다.&nbsp;<br><br>--Rick<br><a href="https://twitter.com/RickAndMSFT">@RickAndMSFT</a>&nbsp;</p>'
