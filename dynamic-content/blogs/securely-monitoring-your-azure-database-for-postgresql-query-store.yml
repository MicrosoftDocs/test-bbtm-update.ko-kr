### YamlMime:Yaml
ms.openlocfilehash: 47f55a2dfb84afd14648f3085034f7d011e3dce6
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/11/2022
ms.locfileid: "139900837"
Slug: securely-monitoring-your-azure-database-for-postgresql-query-store
Title: Azure Database for PostgreSQL 쿼리 저장소를 안전하게 모니터링
Summary: 몇 달 전에 Azure Database for PostgreSQL을 사용하여 메트릭에 대한 경고 모범 사례를 공유했습니다. Azure Database for PostgreSQL에서 특정 주요 메트릭을 모니터링하는 방법을 다룰 수 있었지만 애플리케이션이 많이 의존하는 쿼리의 성능을 모니터링하고 경고하는 방법은 다루지 않았습니다.
Content: >-
  <p>몇 달 전에 <a href="https://azure.microsoft.com/en-us/blog/best-practices-for-alerting-on-metrics-with-azure-database-for-postgresql-monitoring/" target="_blank">Azure Database for PostgreSQL을 사용하여 메트릭에 대한 경고 모범 사례를</a> 공유했습니다. Azure Database for PostgreSQL에서 특정 주요 메트릭을 모니터링하는 방법을 다룰 수 있었지만 애플리케이션이 많이 의존하는 쿼리의 성능을 모니터링하고 경고하는 방법은 다루지 않았습니다. PostgreSQL 데이터베이스로서 때때로 PostgreSQL 데이터베이스에서 무기한 실행 중인 쿼리가 있는지 조사해야 합니다. 이러한 장기 실행 쿼리는 전체 데이터베이스 성능을 방해할 수 있으며 일부 백그라운드 프로세스에서 중단될 수 있습니다. 이 블로그 게시물에서는 <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview" target="_blank">Azure Functions</a> 및 <a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-overview" target="_blank">Azure Key Vault</a>를 사용하여 쿼리 성능 관련 메트릭에 대한 경고를 설정하는 방법을 설명합니다.</p>


  <h2>쿼리 저장소란?</h2>


  <p>쿼리 저장소는 2018년 가을 초에 <a href="https://azure.microsoft.com/en-us/updates/preview-of-query-store-for-azure-database-for-postgresql/" target="_blank">발표된</a> Azure Database for PostgreSQL의 기능으로 시간이 지남에 따라 쿼리 성능을 원활하게 추적할 수 있습니다. 이렇게 하면 가장 오래 실행되고 리소스를 많이 사용하는 쿼리를 빠르게 찾을 수 있으므로 성능 문제 해결이 간소화됩니다. 쿼리 저장소에 대한 설명서, &ldquo; 사용 시나리오를 방문하여 다양한 시나리오에서 <a href="https://docs.microsoft.com/en-us/azure/postgresql/concepts-query-store-scenarios" target="_blank">쿼리 저장소</a>를 사용하는 방법을 알아봅니다.&rdquo; 쿼리 저장소를 사용하도록 설정하면 쿼리 런타임 및 대기 통계의 기록이 자동으로 캡처됩니다. 데이터베이스 사용 패턴을 볼 수 있도록 시간이 지남에 따라 이 데이터를 추적합니다. 모든 사용자, 데이터베이스 및 쿼리에 대한 데이터는 Azure Database for PostgreSQL 인스턴스의 <strong>azure_sys</strong>라는 데이터베이스에 저장됩니다.</p>


  <p>쿼리 저장소는 기본적으로 서버에서 사용하도록 설정되지 않습니다. 그러나 쿼리 저장소를 사용하여 <a href="https://docs.microsoft.com/en-us/azure/postgresql/concepts-query-store" target="_blank">성능 모니터링</a> 설명서 &ldquo; 에 자세히 설명된 간단한 단계를 수행하여 서버에서 옵트인하는 것은 매우 간단합니다.&rdquo; 쿼리 저장소를 사용하도록 설정하여 애플리케이션 성능을 모니터링한 후에는 장기 실행 쿼리, 회귀된 쿼리 등 모니터링하려는 다양한 메트릭에 대한 경고를 설정할 수 있습니다.</p>


  <h2>쿼리 저장소 메트릭에 대한 경고를 설정하는 방법</h2>


  <p>Azure Functions 및 Azure Key Vault를 사용하여 쿼리 저장소 메트릭 모니터링에 대해 거의 실시간으로 경고를 수행할 수 있습니다. 이 <a href="https://github.com/Azure/azure-postgresql/tree/master/samples/query-store/a-single-if-then-this-alert" target="_blank">GitHub 리포지토리</a>는 간단한 모니터링 솔루션을 배포하는 Azure Function 및 PowerShell 스크립트를 제공하므로 경고할 시기와 시기를 유연하게 변경할 수 있습니다.</p>


  <p>또는 리포지토리를 복제하여 이를 시작점으로 사용하고 시나리오에 맞게 코드를 변경할 수 있습니다. Visual Studio 솔루션은 변경 내용으로 빌드될 때 여기에 설명된 것과 동일한 방식으로 배포를 완료하는 데 필요한 zip 파일을 자동으로 패키지합니다.</p>


  <p>이 리포지토리에서 <strong>DeployFunction 스크립트는</strong> Azure Database for PostgreSQL 쿼리 저장소의 모니터 역할을 하는 Azure 함수를 만듭니다. <a href="https://docs.microsoft.com/en-us/azure/postgresql/concepts-query-store" target="_blank">쿼리 성능 인사이트를</a> 통해 수집된 데이터를 이해하면 경고할 수 있는 메트릭을 식별하는 데 도움이 됩니다.</p>


  <p>스크립트 또는 함수 코드 자체를 변경하지&#39;않고 <strong>DeployFunction </strong>스크립트에 필요한 매개 변수만 제공하는 경우 다음을 수행합니다.</p>


  <ul>
   <li>함수 앱입니다.</li>
   <li>1분마다 트리거되는 PingMyDatabase라는 함수입니다.</li>
   <li>쿼리 저장소 데이터가 디스크에 마지막으로 플러시된 이후 평균 실행 시간이 5초보다 긴 쿼리를 찾는 경고 조건입니다.</li>
   <li>경고 조건이 인스턴스에서 실행 중인 모든 프로세스의 연결된 목록과 장기 실행 쿼리 목록을 충족하는 경우의 전자 메일입니다.</li>
   <li>데이터베이스에 대한 연결 문자열과 보낸 사람 전자 메일 계정에 대한 암호를 각각 보유<strong> 하는 pgConnectionString</strong> 및 <strong>senderSecret </strong>이라는 두 개의 비밀을 포함하는 키 자격 증명 모음입니다.</li>
   <li>이 키 자격 증명 모음에 대한 비밀에 대한 Get 정책에 액세스할 수 있는 함수 앱의 ID입니다.</li>
  </ul>


  <p>Windows PowerShell 명령 프롬프트에서 <strong>DeployFunction</strong>을 실행하기만 하면 됩니다. Windows PowerShell 이 스크립트를 실행하는 것이 중요합니다. 일부 매크로가 예상대로 확인되지 않을 수 있으므로 Windows PowerShell ISE를 사용하면 오류가 발생할 수 있습니다.</p>


  <p>그런 다음 스크립트는 리소스 그룹을 만들고 Key Vault는 모니터링 함수 앱을 배포하고, 앱 구성 설정을 업데이트하고, 필요한 Key Vault 비밀을 설정합니다. 배포하는 동안 언제든지 <strong>.\logs</strong> 폴더에서 사용할 수 있는 로그를 볼 수 있습니다.</p>


  <p>배포가 완료되면 Azure Portal의 리소스 그룹으로 이동하여 비밀의 유효성을 검사할 수 있습니다. 다음 다이어그램에 표시된 것처럼 <strong>pgConnString</strong> 및 <strong>senderSecret</strong>이라는 두 개의 비밀 키가 만들어집니다. 값을 업데이트하려는 경우 개별 비밀을 선택할 수 있습니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ff86a552-0a1b-4c80-896d-964df791a080.png"><img alt="Screenshot of two secret keys being created" border="0" height="587" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f64268fb-a941-491f-9ad6-801bdacb8f19.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="생성 중인 두 비밀 키의 스크린샷" width="1431"></a></p>


  <p><br>

  <strong>SENDMAILIF_QUERYRETURNSRESULTS</strong> 앱 설정에 설정된 조건에 따라 조건이 충족되면 이메일 경고를 받게 됩니다.</p>


  <h2>전자 메일에서 경고 조건 또는 지원 데이터를 사용자 지정하는 방법</h2>


  <p>기본 배포가 완료되면 Azure Portal을 사용하여 <strong>플랫폼 기능을</strong> 선택한 다음 <strong>애플리케이션 설정을 선택하여 설정을</strong> 업데이트할 수 있습니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5f26a5c0-1dfb-48d7-a146-f8ab66c5dd2d.png"><img alt="Screenshot of Platform features page" border="0" height="431" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/86e84c0b-5900-4b2a-8b8d-a708972b49b0.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="플랫폼 기능 페이지의 스크린샷" width="640"></a></p>


  <p>아래 설정을 변경하고 종료에 저장하여 연결될 실행 간격, 메일, 조건 또는 지원 데이터를 변경할 수 있습니다.</p>


  <p>또는 <strong>az cli</strong> 를 사용하여 다음과 같은 설정을 업데이트할 수 있습니다.</p>


  <pre>

  $cronIntervalSetting=&quot;CronTimerInterval=0 */1 * * * *&quot;


  az functionapp config appsettings set --resource-group yourResourceGroupName --name yourFunctionAppName --settings $cronIntervalSetting</pre>


  <p>또는</p>


  <pre>

  az functionapp config appsettings set --resource-group $resourceGroupName --name $functionAppName --settings &quot;SENDMAILIF_QUERYRETURNSRESULTS=select * from query_store.qs_view where mean_time &gt; 5000 and start_time &gt;= now() - interval &#39;15 minutes&#39;&quot;</pre>


  <p>다음은 배포가 진행된 후 함수 앱 설정을 업데이트하거나 배포 전에 <strong>DeployFunction.ps1</strong> 해당 값을 업데이트하여 모니터링하고 경고할 수 있는 조건에 대한 일반적인 사례입니다.</p>


  <table border="1" cellpadding="0" cellspacing="0">
   <tbody>
    <tr>
     <td valign="top" width="119">
     <p><strong>경우</strong></p>
     </td>
     <td valign="top" width="286">
     <p><strong>함수 앱 설정 이름</strong></p>
     </td>
     <td valign="top" width="217">
     <p><strong>샘플 값</strong></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="119">
     <p>쿼리 3589441560 지난 15분 동안 평균 <i>x</i> 밀리초 이상 소요됨</p>
     </td>
     <td valign="top" width="286">
     <p>SENDMAILIF_QUERYRETURNSRESULTS</p>
     </td>
     <td valign="top" width="217">
     <p>select * from query_store.qs_view where query_id = 3589441560 and mean_time &gt; x and start_time &gt;= now() - interval &#39;15분&#39;</p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="119">
     <p>캐시가 90% 미만인 쿼리</p>
     </td>
     <td valign="top" width="286">
     <p>SENDMAILIF_QUERYRETURNSRESULTS</p>
     </td>
     <td valign="top" width="217">
     <p>select * , shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) as cache_hit from query_store.qs_view where shared_blks_hit /nullif(shared_blks_hit + shared_blks_read, 0) &lt; 0.90</p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="119">
     <p>평균 실행 시간이 x밀리초보다 큰 쿼리</p>
     </td>
     <td valign="top" width="286">
     <p>SENDMAILIF_QUERYRETURNSRESULTS</p>
     </td>
     <td valign="top" width="217">
     <p>select * from query_store.qs_view where mean_time &gt; x and start_time &gt;= now() - interval &#39;15분&#39;</p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="119">
     <p>경고 조건이 충족되면 진행 중인 자동 진공 작업이 있는지 확인하고 실행 중인 프로세스를 나열하고 결과를 메일에 첨부합니다.</p>
     </td>
     <td valign="top" width="286">
     <p>LIST_OF_QUERIESWITHSUPPORTINGDATA</p>
     </td>
     <td valign="top" width="217">
     <p>{count_of_active_autovacuum: select count(*) from pg_stat_activity where position(&#39;autovacuum:&#39; IN query) = 1 &ldquo;,&quot;list_of_processes_at_the_time_of_alert&quot;:&quot;select now()-query_start as Running_Since,pid,client_hostname,client_addr, usename, state, left(query,60) as query_text pg_stat_activity&quot;}&rdquo;&rdquo;&ldquo;</p>
     </td>
    </tr>
   </tbody>
  </table>


  <h2>얼마나 안전한가요?</h2>


  <p>스크립트는 비밀을 Key Vault에 저장하는 메커니즘을 제공합니다. 비밀은 전송 중 및 미사용 시 암호화되므로 보호됩니다. 그러나 함수 앱은 네트워크를 통해 Key Vault에 액세스합니다. 이를 방지하고 백본을 통해 VNet(가상 네트워크)을 통해 비밀에 액세스하려면 함수 앱과 Key Vault 모두에 대해 VNet을 구성해야 합니다. 함수 앱의 VNet 지원은 미리 보기 상태이며 현재 선택한 Azure 지역에서 사용할 수 있습니다. 적절한 배포 시나리오가 지원되면 이 스크립트를 다시 검토하여 변경 내용을 수용할 수 있습니다. 그때까지 아래 설정을 수행하려면 VNet을 수동으로 구성해야 합니다.</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1a1214b8-224d-4d2b-991e-b3eadde0a0f1.png"><img alt="Flowchart display of manually configruing a VNet" border="0" height="457" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0699fc02-1005-4d81-8783-9873c1b0e008.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="VNet을 수동으로 구성하는 순서도 표시" width="640"></a></p>


  <p>당사는 항상 여러분의 의견을 듣고자 합니다. PostgreSQL의 쿼리 저장소에 대한 피드백이 있거나 쿼리 성능에 대한 모니터링 및 경고가 있는 경우 주저하지 말고&rsquo; <a href="mailto:AzureDatabaseforMySQLPostgreSQL@service.microsoft.com">Azure Database for PostgreSQL 팀에</a> 문의하세요.</p>


  <h2>감사의 글</h2>


  <p>스크립트를 개발하고 이 게시물에 기여한 수석 데이터 과학자 인 Korhan Ileri에게 특별한 감사드립니다. Azure CLI 팀의 소프트웨어 엔지니어인 Tosin Adewale뿐만 아니라 Microsoft와 긴밀하게 협력합니다.</p>
